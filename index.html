<html>
    <head>
<style>
html {
    background-color: #424142;
    color: #ffffff;
}
#sounds {display: flex; margin: 0 auto; width: 550px; justify-content: space-evenly;}
.audio {
    display: flex;
    flex-direction: column;
}
#btns {display: flex; margin: 0 auto; width: 350px; justify-content: center;}
input[type="range"] {
    width: 28px;
    appearance: slider-vertical;
    writing-mode: bt-lr;
}
#ctrls {
    display: flex;
    flex-direction: row;
    justify-content: center;
    margin: 40px;
}
</style>
    </head>
    <body>
        <div id="app"></div>
    <script src="howler.min.js"></script>
    <script type="module">
/**
 * ready
 *
 * Function to call when the DOM is ready
 * Example: ready(() => { do_stuff() });
 */
const ready = (fn) => {
    if (document.readyState != "loading") fn();
    else document.addEventListener("DOMContentLoaded", fn);
};

const App = {
    files: [
        '001-beginning-looped.ogg',
        '002-white-mountain-looped.ogg',
        '003-dusk-looped.ogg',
        '004-salmacis-looped.ogg',
        '005-suppers-ready-looped.ogg',
        '006-wardrobe-looped.ogg',
        '007-fly-looped.ogg',
        '008-waiting-room-looped.ogg',
        '009-slippermen-looped.ogg',
        '010-ravine-looped.ogg',
        '011-ripples-looped.ogg',
        '012-unquiet-slumbers-looped.ogg',
        '013-down-and-out-looped.ogg',
        '014-duchess-looped.ogg',
        'moonlight-knight-outro.ogg',
    ],
    fade_out_dur: 5000,
    fade_in_dur: 10000,
    sounds: [],
    play_heads: [],
    init: function() {
        this.make_arena();
        this.load_sounds();
        this.make_sounds();
        this.bind();
        // this.play_heads.push(this.pick_random(0, this.sounds.length));
    },
    make_arena: function() {
        const app = document.getElementById('app');
        app.innerHTML = `<div id="sounds"></div>
        <div id="ctrls">
            <button id="start">Play</button>
            <button id="fade_out_all">Fade out all</button>
        </div>`;
    },
    load_sounds: function() {
        this.files.forEach((item, i) => {
            const audio = new Howl({src: [item], volume: 0.0, loop: true});
            audio.index = i;
            audio.is_fading_in = false;
            audio.is_fading_out = false;
            this.sounds.push(audio);
        });
    },
    make_sounds: function() {
        const ctr = document.getElementById('sounds');
        this.sounds.forEach((item, i) => {
            ctr.innerHTML += `<div class="audio">
            <input type="range" id="vol_${i}" name="vol_${i}" min="0" max="1" step="0.01" value="0" disabled="disabled" />
            <button class="btn" id="btn_${i}" data-index="${i}">${i}</button>
            </div>`;
        });
    },
    bind: function() {
        document.querySelectorAll('.btn').forEach((el) => {
            el.addEventListener('click', (e) => {
                this.toggle_sound(e.target.getAttribute('data-index'));
            });
        });
        document.getElementById('start').addEventListener('click', (e) => {
            this.start_random();
        });
        document.getElementById('fade_out_all').addEventListener('click', (e) => {
            this.fade_out_all();
        });
        this._interval = setInterval(() => {
            this.sync_all();
        }, 100);
    },
    toggle_sound: function(index) {
        const sound = this.sounds[index];
        if (sound.playing() || sound.is_fading_in) {
            this.fade_out(sound);
        } else {
            this.fade_in(sound);
        }
    },
    pick_random: function(min, max) {
        min = Math.ceil(min);
        max = Math.floor(max);
        return Math.floor(Math.random() * (max - min) + min);
    },
    start_random: function() {
        console.log(this.play_heads);
        if (this.play_heads.length) {
            const s1 = this.play_heads.shift();
            this.toggle_sound(s1);
        }
        const s2 = this.pick_random(0, this.sounds.length);
        this.play_heads.push(s2);
        this.toggle_sound(s2);
        this.play_timeout = setTimeout(() => {this.start_random()}, 10000);
    },
    fade_in: function(sound) {
        sound.off('fade');
        if (!sound.playing()) {
            sound.play();
        }
        sound.is_fading_in = true;
        sound.is_fading_out = false;
        sound.fade(sound.volume(), 0.8, this.fade_in_dur);
        sound.on('fade', function() {
            this.is_fading_in = false;
        });
    },
    fade_out: function(sound) {
        sound.off('fade');
        sound.is_fading_in = false;
        sound.is_fading_out = true;
        sound.fade(sound.volume(), 0, this.fade_out_dur);
        sound.on('fade', function() {
            this.pause();
            this.is_fading_out = false;
        });
    },
    fade_out_all: function() {
        this.sounds.forEach((item, i) => {
            if (item.playing()) {
                this.fade_out(item);
            }
        });
    },
    sync_all: function() {
        this.sounds.forEach((item, i) => {
            this.sync_volume(i);
        });
    },
    sync_volume: function(index) {
        document.getElementById('vol_' + index).value = this.sounds[index].volume();
    }
}

ready(() => {
    App.init();
    window.app = App;
});
    </script>
    </body>
</html>
